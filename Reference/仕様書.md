# 富士登山階段カウンター（プロトタイプ版）

## 1. プロジェクト概要
日常の階段昇降を富士登山に見立てて記録するWebアプリ。
特定の階段に設置されたQRコードを読み取ることで、標高（段数）を加算していく。

## 2. コアロジック
- **基本単位**: 1段 = 0.2m
- **目標**: 富士山頂 3,776m（累計 18,880段）
- **入力方式**: URLパラメータ（`?id=xxx&steps=yy`）の解析。
- **重複防止**: 
  - `last_read_id`: 直前に読み取ったIDと同じ場合は加算を無効化。
  - `cooldown`: 前回加算から3秒間は、いかなる加算も受け付けない（テスト用、本番では調整可能）。

## 3. マイルストーン表示
- スタート: 0m
- 1合目: 400m
- 5合目: 2,300m
- 8合目: 3,100m
- 頂上: 3,776m

## 4. データ保存
- `LocalStorage` を使用して以下のデータを永続化する。
  - `totalSteps`: 累計段数
  - `lastReadId`: 最後に読み取った場所ID
  - `lastReadTimestamp`: 最終更新日時
  - `history`: 読み取り履歴の配列（日時、ID、段数）
  - `username`: ユーザー名（リアルタイム共有用）

## 5. リアルタイム共有・比較機能
- **同期方式**: Supabase (Database & Realtime)
  - **データ永続化**: climbers テーブルに全ユーザーのデータを保存
  - **リアルタイム更新**: postgres_changes で INSERT/UPDATE を検知
  - **オンライン検知**: Realtime Presence（オンラインカウンター専用）
- **接続情報**:
  - Project URL: `https://awoiafutiomkwgoexrvd.supabase.co`
  - Anon Key: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` （実装済み）
- **共有データ**: `username`, `total_steps`, `station`, `last_updated`
- **比較UI**: 
  - **垂直登山ルート**: 350pxの縦型グラフィックで山を登る様子を表現
  - **登山者アバター**: 各ユーザーを個性的な円形アバター（32px）で表示
    - ユーザー名から自動生成された色（ハッシュベース）
    - 名前の1文字目を表示
    - 自分のアバターは特別表示（42px、ゴールド枠、★マーク付き）
  - **リアルタイムカウンター**: 「現在◯名が登山中」と表示
  - **ツールチップ**: ホバー/タップで名前と標高を表示
- **データ表示**:
  - **初期表示**: アプリ起動時に climbers テーブルから全データを読み込み、全員のアバターを配置
  - **リアルタイム更新**: 誰かが登った時（upsert）に postgres_changes で検知して位置更新
  - **永続表示**: オフラインになってもアバターは山道に残り続ける（オンライン数のみ減少）

## 6. ビジュアル演出
### 6.1 動的背景（全体背景）
標高に応じて背景（CSS Gradient）が変化：
- 0-400m: 麓（紫～青グラデーション）
- 400-2300m: 森林帯（青～緑グラデーション）
- 2300-3100m: 中腹（緑～茶グラデーション）
- 3100-3776m: 岩場～山頂（茶～赤グラデーション）
- 3776m: 頂上（黄金色グラデーション）

### 6.2 垂直登山ルートの背景
縦型の山グラデーション（350px）：
- 0%（下部）: 濃い緑（森林帯）
- 15%: 明るい緑（森林帯上部）
- 45%: 青（中腹）
- 75%: 灰色（岩場）
- 90%: 薄灰（山頂手前）
- 100%（上部）: 白（雪の山頂）

### 6.3 フィードバック
- **QR読み取り成功時**:
  - スマホのバイブレーション（Vibration API）
  - 「ピンポン」風の通知音（Web Audio API）
  - トースト通知「○○段上りました！ナイスクライム！」
- **節目（各合目）到達時**:
  - 全画面の紙吹雪アニメーション（canvas-confetti）
  - 特別な成功通知「○○合目に到達しました！おめでとうございます！」

### 6.4 アニメーション
- **登山者アバターの移動**: CSS transition（0.8秒、cubic-bezier easing）で滑らかに上昇
- **ホバー効果**: アバターが1.3倍に拡大、z-indexで最前面に表示

## 7. 技術スタック
- **HTML/CSS**: Tailwind CSS + DaisyUI (v4.6.0)
- **JavaScript**: Vanilla JS (ES6+)
- **フォント**: Google Fonts (Zen Maru Gothic, Outfit)
- **バックエンド**: Supabase (Database + Realtime Presence)
- **エフェクト**: canvas-confetti (紙吹雪)
- **音声**: Web Audio API (通知音)

## 8. デプロイ
- **ホスティング**: GitHub Pages 推奨
- **必要ファイル**: `index.html`, `app.js`
- **QRコード作成**: 無料QRコード生成サイトでURL + パラメータをエンコード
  - 例: `https://username.github.io/FujisanStep/?id=stair_A&steps=50`

## 9. 管理機能（管理者用）
- **アクセス方法**: 隠しURLパラメータ、または特定の操作で表示される管理者モーダル。
- **機能**:
  - **ユーザー管理**: 登録ユーザーの一覧表示と削除。
  - **データリセット**: 全ユーザーデータのリセット（climbersテーブルのクリア）。
  - **救済措置**: 特定ユーザーへの段数付与（データ消失時の復旧用QR作成、または直接付与）。

## 10. 追加仕様変更（2026/01/27追記）
- **制限ロジック変更**:
  - 変更前: 直前と同じIDは読み取り不可（`last_read_id` チェック）。
  - 変更後: **「同じIDは1日1回まで」**。
    - 場所（ID）ごとの最終読み取り「日付」を記録し、日付が変われば（0時リセット）再度読み取り可能とする。
    - ※ 24時間経過待機ではないため、例えば「23:59に読み取り → 0:01に読み取り」は可能。
- **ランキング機能**:
  - 上位100名を表示するランキングリストを実装。
  - 山のアバター表示は視認性を考慮し、直近のアクティブユーザーやトップ層に絞る等の調整を行う（300人規模対応）。**ただし、自分自身のアバターは常時表示し、位置を見失わないようにする。**

## 11. リセットトークンシステム（2026/01/28追記）
- **問題の背景**:
  - 管理者が「全リセット」を実行しても、ユーザーのブラウザ（localStorage）にデータが残っていた。
  - ユーザーが再度アプリを開くと、ローカルデータがサーバーに再登録されてしまい、リセットが無効化されていた。
- **解決策: リセットトークン方式**:
  - Supabaseに `config` テーブルを作成し、`reset_token` を管理。
  - 管理者がリセット実行時、新しいトークン（タイムスタンプ）を発行。
  - ユーザーがアプリを開いた際、サーバーのトークンとローカルのトークンを比較。
  - 不一致の場合、ローカルデータを自動削除し、ユーザー名入力画面（初期状態）に戻す。
- **configテーブル構成**:
  ```sql
  CREATE TABLE config (
    key TEXT PRIMARY KEY,
    value TEXT
  );
  ```
- **動作フロー**:
  1. 管理者が「全リセット」ボタンを押下
  2. `climbers` テーブルの全データ削除
  3. `config` テーブルの `reset_token` を現在時刻のタイムスタンプに更新
  4. ユーザーがアプリにアクセス時、トークンを比較
  5. 不一致なら `localStorage` を削除し、名前登録画面を表示